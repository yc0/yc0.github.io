<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Design LSM Database | My journey</title><meta name=keywords content="system design,amazon,LSM,onsite"><meta name=description content='LSM Design Overview
The LSM stores data in three distinct data structures:


The shared-memory region. This may actually be allocated in either shared or heap memory


The log file. A circular log file that provides a persistent backup of the contents of the in-memory tree and any other data that has not yet been synced to disk.


The database file. A database file consists of an 8KB header and a body. The body contains zero or more "sorted runs" - arrays of key-value pairs sorted by key.'><meta name=author content="Nelson"><link rel=canonical href=https://yc0.github.io/posts/design-lsm-database/><link crossorigin=anonymous href=/assets/css/stylesheet.a090830a421002426baafbd314e38f149d77b4c48a12ee9312700d770b27fb26.css integrity="sha256-oJCDCkIQAkJrqvvTFOOPFJ13tMSKEu6TEnANdwsn+yY=" rel="preload stylesheet" as=style><link rel=icon href=https://yc0.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://yc0.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://yc0.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://yc0.github.io/apple-touch-icon.png><link rel=mask-icon href=https://yc0.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://yc0.github.io/posts/design-lsm-database/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://yc0.github.io/posts/design-lsm-database/"><meta property="og:site_name" content="My journey"><meta property="og:title" content="Design LSM Database"><meta property="og:description" content='LSM Design Overview The LSM stores data in three distinct data structures:
The shared-memory region. This may actually be allocated in either shared or heap memory
The log file. A circular log file that provides a persistent backup of the contents of the in-memory tree and any other data that has not yet been synced to disk.
The database file. A database file consists of an 8KB header and a body. The body contains zero or more "sorted runs" - arrays of key-value pairs sorted by key.'><meta property="og:locale" content="zh-tw"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-10-23T11:41:20+00:00"><meta property="article:modified_time" content="2025-10-25T10:47:02+08:00"><meta property="article:tag" content="System Design"><meta property="article:tag" content="Amazon"><meta property="article:tag" content="LSM"><meta property="article:tag" content="Onsite"><meta name=twitter:card content="summary"><meta name=twitter:title content="Design LSM Database"><meta name=twitter:description content='LSM Design Overview
The LSM stores data in three distinct data structures:


The shared-memory region. This may actually be allocated in either shared or heap memory


The log file. A circular log file that provides a persistent backup of the contents of the in-memory tree and any other data that has not yet been synced to disk.


The database file. A database file consists of an 8KB header and a body. The body contains zero or more "sorted runs" - arrays of key-value pairs sorted by key.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://yc0.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Design LSM Database","item":"https://yc0.github.io/posts/design-lsm-database/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Design LSM Database","name":"Design LSM Database","description":"LSM Design Overview The LSM stores data in three distinct data structures:\nThe shared-memory region. This may actually be allocated in either shared or heap memory\nThe log file. A circular log file that provides a persistent backup of the contents of the in-memory tree and any other data that has not yet been synced to disk.\nThe database file. A database file consists of an 8KB header and a body. The body contains zero or more \u0026quot;sorted runs\u0026quot; - arrays of key-value pairs sorted by key.\n","keywords":["system design","amazon","LSM","onsite"],"articleBody":"LSM Design Overview The LSM stores data in three distinct data structures:\nThe shared-memory region. This may actually be allocated in either shared or heap memory\nThe log file. A circular log file that provides a persistent backup of the contents of the in-memory tree and any other data that has not yet been synced to disk.\nThe database file. A database file consists of an 8KB header and a body. The body contains zero or more \"sorted runs\" - arrays of key-value pairs sorted by key.\nTo query a database, the contents of the in-memory tree must be merged with the contents of each sorted run in the database file. Entries from newer sorted runs are favoured over old (for the purposes of merging, the in-memory tree contains the newest data).\nIn summary LSM embedded database software stores data in three distinct data structures:\nThe shared-memory region. This may actually be allocated in either shared or heap memory, depending on whether LSM is running in multi (the default) or single process mode. Either way, the shared-memory region contains volatile data that is shared at run-time between database clients. Similar to the *-shm file used by SQLite in WAL mode. As well as various fixed-size fields, the shared-memory region contains the ‘in-memory tree’. The in-memory tree is an append-only red-black tree structure used to stage user data that has not yet flushed into the database file by the system. Under normal circumstances, the in-memory tree is not allowed to grow very large.\nThe log file. A circular log file that provides a persistent backup of the contents of the in-memory tree and any other data that has not yet been synced to disk. The log-file is not used for rollback (like an SQLite journal file) or to store data that is retrieved at runtime by database clients (like an SQLite WAL file). Its only purpose is to provide robustness.\nThe database file. A database file consists of an 8KB header and a body. The body contains zero or more “sorted runs” - arrays of key-value pairs sorted by key.\nTo query a database, the contents of the in-memory tree must be merged with the contents of each sorted run in the database file. Entries from newer sorted runs are favoured over old (for the purposes of merging, the in-memory tree contains the newest data).\nWhen an application writes to the database, the new data is written to the in-memory tree. Once the in-memory tree has grown large enough, its contents are written into the database file as a new sorted run. To reduce the number of sorted runs in the database file, chronologically adjacent sorted runs may be merged together into a single run, either automatically or on demand.\nLocks Read/write (shared/exclusive) file locks are used to control concurrent access. LSM uses the following “locking regions”. Each locking region may be locked and unlocked separately.\nTypes 內容 DMS1 This locking region is used to serialize all connection and disconnection operations performed by read-write database connections. An EXCLUSIVE lock is taken for the duration of all such operations.　Additionally, read-only connections take a SHARED lock on this locking region while attempting to connect to a database. This ensures that a read-only connection does not attempt to connect to the database while a read-write clients connection or disconnection operation is ongoing. DMS2 Read-write connections hold a SHARED lock on this locking region for as long as they are connected to the database. DMS3 Read-only connections hold a SHARED lock on this locking region for as long as they are connected to the database. ｜RWCLIENT(n) There are a total of 16 RWCLIENT locking regions. After a read-write client connects to the database it attempts to find a free RWCLIENT locking slot to take an EXCLUSIVE lock on. If it cannot find one, this is not an error. If it can, then the lock is held for as long as the read-write client is connected to the database for.\nThe sole purpose of these locks is that they allow a read-only client to detect whether or not there exists at least one read-write client connected to the database. Of course if large numbers of read-write clients connect and disconnect from the system in an inconvenient order the system may enter a state where there exists one or more connected read-write clients but none of them hold a RWCLIENT lock. This is not important - if a read-only client fails to detect that the system has read-write clients it may be less efficient, but will not malfunction. WRITER A database client holds an EXCLUSIVE lock on this locking region while writing data to the database. Outside of recovery, only clients holding this lock may modify the contents of the in-memory b-tree. Holding this lock is synonymous with having an open write transaction on the database. WORKER A database client holds an EXCLUSIVE lock on this locking region while performing database work (writing data into the body of the database file). CHECKPOINTER A database client holds an EXCLUSIVE lock on this locking region while performing a checkpoint (syncing the database file and writing to the database header). ROTRANS A read-only database client holds a SHARED lock on this locking region while reading from a non-live database system. READER(n) There are a total of 6 READER locking regions. Unless it is a read-only client reading from a non-live database, a client holds a SHARED lock on one of these while it has an open read transaction. Each READER lock is associated with a pair of id values identifying the regions of the in-memory tree and database file that may be read by clients holding such SHARED locks. Database Connect and Disconnect Operations ","wordCount":"955","inLanguage":"en","datePublished":"2019-10-23T11:41:20Z","dateModified":"2025-10-25T10:47:02+08:00","author":{"@type":"Person","name":"Nelson"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://yc0.github.io/posts/design-lsm-database/"},"publisher":{"@type":"Organization","name":"My journey","logo":{"@type":"ImageObject","url":"https://yc0.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://yc0.github.io/ accesskey=h title="My journey (Alt + H)">My journey</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://yc0.github.io/posts/ title="All Posts"><span>All Posts</span></a></li><li><a href=https://yc0.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://yc0.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://yc0.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://yc0.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Design LSM Database</h1><div class=post-meta><span title='2019-10-23 11:41:20 +0000 UTC'>October 23, 2019</span>&nbsp;·&nbsp;<span>5 min</span>&nbsp;·&nbsp;<span>Nelson</span></div></header><div class=post-content><h2 id=lsm-design-overview>LSM Design Overview<a hidden class=anchor aria-hidden=true href=#lsm-design-overview>#</a></h2><p>The LSM stores data in three distinct data structures:</p><ul><li><p>The <code>shared-memory region</code>. This may actually be allocated in either shared or heap memory</p></li><li><p>The log file. A circular log file that provides a persistent backup of the contents of the in-memory tree and any other data that has <code>not yet been synced to disk</code>.</p></li><li><p>The database file. A database file consists of an 8KB <code>header and a body</code>. The body contains <code>zero or more "sorted runs"</code> - arrays of key-value pairs sorted by key.</p></li></ul><p>To query a database, the contents of the in-memory tree must be merged with the contents of each sorted run in the database file. Entries from newer sorted runs are favoured over old (for the purposes of merging, the in-memory tree contains the newest data).</p><h3 id=in-summary>In summary<a hidden class=anchor aria-hidden=true href=#in-summary>#</a></h3><p>LSM embedded database software stores data in three distinct data structures:</p><ul><li>The shared-memory region. This may actually be allocated in either shared or heap memory, depending on whether LSM is running in multi (the default) or single process mode. Either way, the shared-memory region contains volatile data that is shared at run-time between database clients. Similar to the *-shm file used by SQLite in WAL mode.</li></ul><p>As well as various fixed-size fields, the shared-memory region contains the &lsquo;in-memory tree&rsquo;. The in-memory tree is an append-only red-black tree structure used to stage user data that has not yet flushed into the database file by the system. Under normal circumstances, the in-memory tree is not allowed to grow very large.</p><ul><li><p>The log file. A circular log file that provides a persistent backup of the contents of the in-memory tree and any other data that has not yet been synced to disk. The log-file is not used for rollback (like an SQLite journal file) or to store data that is retrieved at runtime by database clients (like an SQLite WAL file). Its only purpose is to provide robustness.</p></li><li><p>The database file. A database file consists of an 8KB header and a body. The body contains zero or more &ldquo;sorted runs&rdquo; - arrays of key-value pairs sorted by key.</p></li></ul><p>To query a database, the contents of the in-memory tree must be merged with the contents of each sorted run in the database file. Entries from newer sorted runs are favoured over old (for the purposes of merging, the in-memory tree contains the newest data).</p><p>When an application writes to the database, the new data is written to the in-memory tree. Once the in-memory tree has grown large enough, its contents are written into the database file as a new sorted run. To reduce the number of sorted runs in the database file, chronologically adjacent sorted runs may be merged together into a single run, either automatically or on demand.</p><h3 id=locks>Locks<a hidden class=anchor aria-hidden=true href=#locks>#</a></h3><p>Read/write (shared/exclusive) file locks are used to control concurrent access. LSM uses the following &ldquo;locking regions&rdquo;. Each locking region may be locked and unlocked separately.</p><table><thead><tr><th>Types</th><th>內容</th></tr></thead><tbody><tr><td>DMS1</td><td>This locking region is used to serialize all connection and disconnection operations performed by read-write database connections. An EXCLUSIVE lock is taken for the duration of all such operations.　<br><br>Additionally, read-only connections take a SHARED lock on this locking region while attempting to connect to a database. This ensures that a read-only connection does not attempt to connect to the database while a read-write clients connection or disconnection operation is ongoing.</td></tr><tr><td>DMS2</td><td>Read-write connections hold a SHARED lock on this locking region for as long as they are connected to the database.</td></tr><tr><td>DMS3</td><td>Read-only connections hold a SHARED lock on this locking region for as long as they are connected to the database.</td></tr><tr><td>｜RWCLIENT(n)</td><td>There are a total of 16 RWCLIENT locking regions. After a read-write client connects to the database it attempts to find a free RWCLIENT locking slot to take an EXCLUSIVE lock on. If it cannot find one, this is not an error. If it can, then the lock is held for as long as the read-write client is connected to the database for.<br><br>The sole purpose of these locks is that they allow a read-only client to detect whether or not there exists at least one read-write client connected to the database. Of course if large numbers of read-write clients connect and disconnect from the system in an inconvenient order the system may enter a state where there exists one or more connected read-write clients but none of them hold a RWCLIENT lock. This is not important - if a read-only client fails to detect that the system has read-write clients it may be less efficient, but will not malfunction.</td></tr><tr><td>WRITER</td><td>A database client holds an EXCLUSIVE lock on this locking region while writing data to the database. Outside of recovery, only clients holding this lock may modify the contents of the in-memory b-tree. Holding this lock is synonymous with having an open write transaction on the database.</td></tr><tr><td>WORKER</td><td>A database client holds an EXCLUSIVE lock on this locking region while performing database work (writing data into the body of the database file).</td></tr><tr><td>CHECKPOINTER</td><td>A database client holds an EXCLUSIVE lock on this locking region while performing a checkpoint (syncing the database file and writing to the database header).</td></tr><tr><td>ROTRANS</td><td>A read-only database client holds a SHARED lock on this locking region while reading from a non-live database system.</td></tr><tr><td>READER(n)</td><td>There are a total of 6 READER locking regions. Unless it is a read-only client reading from a non-live database, a client holds a SHARED lock on one of these while it has an open read transaction. Each READER lock is associated with a pair of id values identifying the regions of the in-memory tree and database file that may be read by clients holding such SHARED locks.</td></tr></tbody></table><h3 id=database-connect-and-disconnect-operations>Database Connect and Disconnect Operations<a hidden class=anchor aria-hidden=true href=#database-connect-and-disconnect-operations>#</a></h3></div><footer class=post-footer><ul class=post-tags><li><a href=https://yc0.github.io/tags/system-design/>System Design</a></li><li><a href=https://yc0.github.io/tags/amazon/>Amazon</a></li><li><a href=https://yc0.github.io/tags/lsm/>LSM</a></li><li><a href=https://yc0.github.io/tags/onsite/>Onsite</a></li></ul><nav class=paginav><a class=prev href=https://yc0.github.io/posts/use-exception-instead-of-error-code/><span class=title>« Prev</span><br><span>Use exception instead of error code</span>
</a><a class=next href=https://yc0.github.io/posts/design-a-locker/><span class=title>Next »</span><br><span>Design a locker</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://yc0.github.io/>My journey</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>